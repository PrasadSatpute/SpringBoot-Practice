<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Spring Security</title>
    <style>
        /* BASE STYLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* HEADER/NAVBAR */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand h1 {
            font-size: 24px;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            text-align: right;
        }

        .user-info p {
            margin: 2px 0;
            font-size: 14px;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 4px;
        }

        .role-admin {
            background: #ffc107;
            color: #000;
        }

        .role-user {
            background: #28a745;
            color: white;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        /* CONTAINER */
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* WELCOME SECTION */
        .welcome-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .welcome-card h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .welcome-card p {
            color: #666;
            line-height: 1.6;
        }

        /* USER MANAGEMENT SECTION */
        .management-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-header h3 {
            color: #333;
            font-size: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        /* TABLE STYLES */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px;
            text-align: left;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 15px;
            border-top: 1px solid #f0f0f0;
            color: #555;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        /* ACTION BUTTONS */
        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-edit {
            background: #17a2b8;
            color: white;
        }

        .btn-edit:hover {
            background: #138496;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 100px auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* LOADING SPINNER */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ACCESS DENIED MESSAGE */
        .access-denied {
            background: #fff3cd;
            color: #856404;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ffeaa7;
        }

        .access-denied h3 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<!--
DASHBOARD PAGE - SPRING SECURITY IN ACTION
===========================================

THYMELEAF SECURITY FEATURES:

1. sec:authorize="hasRole('ADMIN')":
   - Shows/hides content based on user's role
   - Evaluated on server-side (secure)
   - Admin sees create/edit/delete buttons
   - User sees read-only view

2. th:text="${username}":
   - Displays data passed from controller
   - Data comes from SecurityContext

3. JavaScript AJAX calls to REST API:
   - Uses Spring Security session for authentication
   - Session cookie (JSESSIONID) sent automatically
   - API checks @PreAuthorize annotations

AUTHORIZATION FLOW:
- Admin: Can see and use all features
- User: Can see data but buttons are hidden
- If User tries API call via browser console:
  ‚Üí 403 Forbidden error (server-side protection)
-->

<!-- NAVIGATION BAR -->
<nav class="navbar">
    <div class="navbar-brand">
        <h1>üõ°Ô∏è Spring Security Dashboard</h1>
    </div>
    <div class="navbar-user">
        <div class="user-info">
            <!-- Display logged-in username -->
            <p>Welcome, <strong th:text="${username}">User</strong>!</p>
            <!-- Display user role with appropriate badge -->
            <span th:if="${role == 'ADMIN'}" class="role-badge role-admin">üëë ADMIN</span>
            <span th:if="${role == 'USER'}" class="role-badge role-user">üë§ USER</span>
        </div>
        <!-- LOGOUT FORM -->
        <form th:action="@{/logout}" method="post" style="margin: 0;">
            <button type="submit" class="btn-logout">Logout</button>
        </form>
    </div>
</nav>

<!-- MAIN CONTAINER -->
<div class="container">
    <!-- WELCOME SECTION -->
    <div class="welcome-card">
        <h2>Welcome to Your Dashboard!</h2>
        <p th:if="${role == 'ADMIN'}">
            You have <strong>ADMIN</strong> privileges. You can Create, Read, Update, and Delete users.
        </p>
        <p th:if="${role == 'USER'}">
            You have <strong>USER</strong> privileges. You can view the user list, but cannot modify it.
        </p>
    </div>

    <!-- USER MANAGEMENT SECTION -->
    <div class="management-card">
        <div class="card-header">
            <h3>üë• User Management</h3>
            <!-- CREATE BUTTON - Only visible to ADMIN -->
            <!-- sec:authorize="hasRole('ADMIN')" - This is server-side authorization -->
            <button
                    sec:authorize="hasRole('ADMIN')"
                    class="btn-primary"
                    onclick="openCreateModal()">
                ‚ûï Create User
            </button>
        </div>

        <!-- LOADING INDICATOR -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading users...</p>
        </div>

        <!-- USERS TABLE -->
        <table id="usersTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <!-- ACTIONS COLUMN - Only visible to ADMIN -->
                <th sec:authorize="hasRole('ADMIN')">Actions</th>
            </tr>
            </thead>
            <tbody id="usersTableBody">
            <!-- Users will be loaded here via JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- CREATE/EDIT USER MODAL -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Create User</h3>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <input type="hidden" id="userId">

                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" required placeholder="Enter username">
                </div>

                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required placeholder="Enter email">
                </div>

                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password" id="password" required placeholder="Enter password">
                </div>

                <div class="form-group">
                    <label for="role">Role *</label>
                    <select id="role" required>
                        <option value="">Select Role</option>
                        <option value="ADMIN">Admin</option>
                        <option value="USER">User</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" onclick="saveUser()">Save</button>
        </div>
    </div>
</div>

<!-- JAVASCRIPT FOR USER MANAGEMENT -->
<script th:inline="javascript">
    /*
    JAVASCRIPT SECURITY FLOW
    ========================

    When Admin performs an action (Create/Update/Delete):

    STEP 1: JavaScript function is called (e.g., deleteUser)
    STEP 2: AJAX request is sent to REST API endpoint
    STEP 3: Browser automatically includes session cookie (JSESSIONID)
    STEP 4: Request enters Spring Security Filter Chain
    STEP 5: SecurityContextPersistenceFilter loads authentication from session
    STEP 6: AuthorizationFilter checks URL permissions
    STEP 7: Request reaches controller method
    STEP 8: @PreAuthorize("hasRole('ADMIN')") is evaluated
    STEP 9: If user has ROLE_ADMIN ‚Üí Method executes
            If user doesn't have ROLE_ADMIN ‚Üí 403 Forbidden
    STEP 10: Response is returned to JavaScript
    STEP 11: JavaScript updates the UI

    When Normal User tries to call API:
    - JavaScript won't show buttons (UI protection)
    - But if user tries via browser console:
      ‚Üí API will return 403 Forbidden
      ‚Üí Server-side @PreAuthorize prevents unauthorized access
    */

    // Get current user's role from Thymeleaf
    // This is used for client-side UI control
    const userRole = /*[[${role}]]*/ 'USER';
    const isAdmin = userRole === 'ADMIN';

    console.log('==============================================');
    console.log('Dashboard loaded for user role:', userRole);
    console.log('Is Admin:', isAdmin);
    console.log('==============================================');

    // Current editing user ID
    let currentEditId = null;

    /**
     * LOAD USERS FROM API
     * ===================
     * Fetches all users from REST API endpoint
     *
     * SECURITY:
     * - API endpoint /api/users requires ROLE_ADMIN
     * - But we call it for both ADMIN and USER
     * - ADMIN: Gets user list successfully
     * - USER: Gets 403 Forbidden error (handled in catch block)
     */
    function loadUsers() {
        console.log('Loading users from API...');

        // Show loading spinner
        document.getElementById('loading').style.display = 'block';
        document.getElementById('usersTable').style.display = 'none';

        // Make AJAX call to REST API
        // Session cookie is automatically included
        fetch('/api/users', {
            method: 'GET',
            credentials: 'same-origin' // Include cookies
        })
        .then(response => {
            console.log('API Response Status:', response.status);

            // Check if response is successful
            if (!response.ok) {
                // If 403 Forbidden - User doesn't have permission
                if (response.status === 403) {
                    throw new Error('ACCESS_DENIED');
                }
                throw new Error('Failed to load users');
            }
            return response.json();
        })
        .then(users => {
            console.log('Users loaded successfully:', users.length);

            // Hide loading, show table
            document.getElementById('loading').style.display = 'none';
            document.getElementById('usersTable').style.display = 'table';

            // Populate table with users
            displayUsers(users);
        })
        .catch(error => {
            console.error('Error loading users:', error);

            document.getElementById('loading').style.display = 'none';

            // If access denied, show appropriate message
            if (error.message === 'ACCESS_DENIED') {
                console.log('User does not have permission to view users');
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="access-denied">
                                <h3>üîí Access Denied</h3>
                                <p>You don't have permission to view the user list.</p>
                                <p>Only administrators can access this resource.</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: red;">
                            Error loading users. Please try again.
                        </td>
                    </tr>
                `;
            }

            document.getElementById('usersTable').style.display = 'table';
        });
    }

    /**
     * DISPLAY USERS IN TABLE
     * ======================
     * Renders user data in HTML table
     * Shows action buttons only for ADMIN role
     */
    function displayUsers(users) {
        const tbody = document.getElementById('usersTableBody');

        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: #999;">
                        No users found
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>
                    <span class="role-badge ${user.role === 'ADMIN' ? 'role-admin' : 'role-user'}">
                        ${user.role}
                    </span>
                </td>
                <td>${user.enabled ? '‚úì Active' : '‚úó Disabled'}</td>
                ${isAdmin ? `
                    <td>
                        <div class="btn-group">
                            <button class="btn-edit" onclick="openEditModal(${user.id})">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn-delete" onclick="deleteUser(${user.id})">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </td>
                ` : ''}
            </tr>
        `).join('');
    }

    /**
     * OPEN CREATE MODAL
     * =================
     * Opens modal for creating new user
     *
     * SECURITY:
     * - Button is only visible to ADMIN (sec:authorize)
     * - But we add JavaScript check as well
     * - If USER somehow calls this, API will reject with 403
     */
    function openCreateModal() {
        console.log('Opening create user modal');

        // CLIENT-SIDE CHECK: Only admin can create
        if (!isAdmin) {
            alert('üîí Access Denied: Only administrators can create users.');
            console.error('Non-admin user tried to create user');
            return;
        }

        // Reset form
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('modalTitle').textContent = 'Create User';
        document.getElementById('password').required = true;

        currentEditId = null;

        // Show modal
        document.getElementById('userModal').style.display = 'block';
    }

    /**
     * OPEN EDIT MODAL
     * ===============
     * Opens modal for editing existing user
     *
     * SECURITY:
     * - Button is only visible to ADMIN
     * - Loads user data from API
     * - API requires ROLE_ADMIN
     */
    function openEditModal(userId) {
        console.log('Opening edit modal for user ID:', userId);

        // CLIENT-SIDE CHECK: Only admin can edit
        if (!isAdmin) {
            alert('üîí Access Denied: Only administrators can edit users.');
            console.error('Non-admin user tried to edit user');
            return;
        }

        currentEditId = userId;

        // Fetch user data from API
        fetch(`/api/users/${userId}`, {
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('ACCESS_DENIED');
                }
                throw new Error('Failed to load user');
            }
            return response.json();
        })
        .then(user => {
            console.log('User data loaded for editing:', user);

            // Populate form with user data
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('role').value = user.role;
            document.getElementById('password').value = '';
            document.getElementById('password').required = false; // Password optional for edit
            document.getElementById('modalTitle').textContent = 'Edit User';

            // Show modal
            document.getElementById('userModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading user:', error);
            if (error.message === 'ACCESS_DENIED') {
                alert('üîí Access Denied: You don\'t have permission to edit users.');
            } else {
                alert('Error loading user data. Please try again.');
            }
        });
    }

    /**
     * CLOSE MODAL
     * ===========
     * Closes the create/edit modal
     */
    function closeModal() {
        console.log('Closing modal');
        document.getElementById('userModal').style.display = 'none';
        document.getElementById('userForm').reset();
        currentEditId = null;
    }

    /**
     * SAVE USER (CREATE OR UPDATE)
     * ============================
     * Saves user data via REST API
     *
     * SECURITY FLOW:
     * - Determines if creating new user or updating existing
     * - Sends POST (create) or PUT (update) request to API
     * - API endpoint requires ROLE_ADMIN (@PreAuthorize)
     * - If user is not ADMIN ‚Üí 403 Forbidden
     * - Session authentication is automatic (cookie)
     */
    function saveUser() {
        console.log('Saving user...');

        // CLIENT-SIDE CHECK: Only admin can save
        if (!isAdmin) {
            alert('üîí Access Denied: Only administrators can save users.');
            console.error('Non-admin user tried to save user');
            return;
        }

        // Get form data
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;

        // Validate form
        if (!username || !email || !role) {
            alert('Please fill in all required fields');
            return;
        }

        // For create, password is required
        if (!userId && !password) {
            alert('Password is required when creating a new user');
            return;
        }

        // Prepare request data
        const userData = {
            username: username,
            email: email,
            role: role
        };

        // Include password only if provided
        if (password) {
            userData.password = password;
        }

        // Determine if creating or updating
        const isEdit = userId !== '';
        const url = isEdit ? `/api/users/${userId}` : '/api/users';
        const method = isEdit ? 'PUT' : 'POST';

        console.log(`${isEdit ? 'Updating' : 'Creating'} user:`, userData);

        // Make API call
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(userData)
        })
        .then(response => {
            console.log('API Response Status:', response.status);

            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('ACCESS_DENIED');
                }
                // Try to get error message from response
                return response.text().then(text => {
                    throw new Error(text || 'Failed to save user');
                });
            }
            return response.json();
        })
        .then(savedUser => {
            console.log('User saved successfully:', savedUser);
            alert(`‚úì User ${isEdit ? 'updated' : 'created'} successfully!`);

            // Close modal and reload users
            closeModal();
            loadUsers();
        })
        .catch(error => {
            console.error('Error saving user:', error);

            if (error.message === 'ACCESS_DENIED') {
                alert('üîí Access Denied: You don\'t have permission to save users.');
            } else {
                alert('Error: ' + error.message);
            }
        });
    }

    /**
     * DELETE USER
     * ===========
     * Deletes a user via REST API
     *
     * SECURITY FLOW:
     * - Confirms deletion with user
     * - Sends DELETE request to API
     * - API endpoint requires ROLE_ADMIN
     * - If user is not ADMIN ‚Üí 403 Forbidden
     */
    function deleteUser(userId) {
        console.log('Deleting user ID:', userId);

        // CLIENT-SIDE CHECK: Only admin can delete
        if (!isAdmin) {
            alert('üîí Access Denied: Only administrators can delete users.');
            console.error('Non-admin user tried to delete user');
            return;
        }

        // Confirm deletion
        if (!confirm('Are you sure you want to delete this user?')) {
            console.log('User cancelled deletion');
            return;
        }

        // Make DELETE request to API
        fetch(`/api/users/${userId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('API Response Status:', response.status);

            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('ACCESS_DENIED');
                }
                throw new Error('Failed to delete user');
            }
            return response.text();
        })
        .then(message => {
            console.log('User deleted successfully:', message);
            alert('‚úì User deleted successfully!');

            // Reload users
            loadUsers();
        })
        .catch(error => {
            console.error('Error deleting user:', error);

            if (error.message === 'ACCESS_DENIED') {
                alert('üîí Access Denied: You don\'t have permission to delete users.');
            } else {
                alert('Error deleting user. Please try again.');
            }
        });
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('userModal');
        if (event.target === modal) {
            closeModal();
        }
    };

    // Load users when page loads
    window.onload = function() {
        console.log('Page loaded, fetching users...');
        loadUsers();
    };
</script>
</body>
</html>